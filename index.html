<html>
<head>
<title>Microdraw</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,user-scalable=no" />
<style>
html,body {
	margin:0px;
}
* {
	font-family: sans-serif;
	font-size:1rem;
	color:#333;
}
#info {
	position:absolute;
	width:200px;
	height:100%;
	top:0;
	left:0;
	background-color:rgba(200,200,200,0.5);
	z-index:10;
}
#login {
	height:1.5em;
	background-color:rgba(250,250,250,0.5);
}

button{
	width:95px;
	margin:1px;
	padding:2px;
	border:1px solid #c2c2c2;
	background-color:#eee;
	-moz-border-radius:3px;
	-webkit-border-radius:3px;
	border-radius:3px;
}
.selected {
	background-color:#FFC040;
}

#regionList {
	position:relative;
	min-height:30px;
	background-color:rgba(250,250,250,0.5);
	border:0;
}
#regionPicker {
	position:absolute;
	width:200px;
	height:100%;
	top:0;
	left:200px;
	background-color:rgba(200,200,200,0.5);
	padding:5px;
	display:none;
	overflow-y:scroll;
}
.region-tag {
	position: relative;
}
.region-color {
	width:1.5rem;
	height:1.5rem;
	border:thin solid grey;
	display:inline-block;
	vertical-align:middle;
}
.region-tag.selected {
	background-color:rgba(255,255,255,0.75);
}
.region-tag.deselected {
	background-color:transparent;
}
.table {
	display:table;
	table-layout:fixed;
}
.row {
	display:table-row;
}	
.cell {
	display:table-cell;
	width:100%;
}
.overlay {
	border:thin solid red;
	position:absolute;
	top:0;
	left:0;
	pointer-events:none;
}
</style>
</head>

<body>

<div id="info" class="table">
	<div class="row" style="height:10px">
		<div class="cell" id="login"></div>
	</div>
	
	<div class="row" style="height:10px">
		<div class="cell" style="height:150px">
			<div id="myNavigator"  style="width:200px;height:150px"></div>
		</div>
	</div>
	
	<div class="row" style="height:10px">
		<div class="cell" style="text-align:center">
			<button  class="svg" id="zoom" src="navigate.svg">zoom</button>
			<button id="home" src="home.svg">home</button>
			<button id="zoom-in" src="plus.svg">+</button>
			<button id="zoom-out" src="minus.svg">-</button>
			<button id="select">select</button>
			<button id="draw">draw</button>
			<button id="delete">delete</button>
			<button id="addpoint">+point</button>
			<button id="delpoint">-point</button>
			<button id="addregion">add</button>
			<button id="delregion">subtract</button>
			<button id="splitregion">split</button>
			<button id="save">save</button>
		</div>
	</div>

	<div class="row">
		<div class="cell">
			<br />
			Regions
			<div id="regionList" style="height:auto;margin-bottom:0;overflow-y:scroll"></div>
		</div>
	</div>
</div>

<div id="regionPicker">
</div>

<div id="openseadragon1" style="width:100%"></div>

<div style="position:absolute;bottom:5px;right:5px">
	<img src="naat.svg" style="width:3em" />
</div>

<script src="lib/paper-full.min.js"></script>
<script src="lib/openseadragon/openseadragon.min.js"></script>
<script src="lib/openseadragon-viewerinputhook.min.js"></script>
<script src="lib/OpenSeadragonScalebar/openseadragon-scalebar.js"></script>
<script src="lib/jquery-1.11.0.min.js"></script>
<script src="lib/mylogin/login.js"></script>
<script>
/*
	Example Ontology
*/
var Ontology=[{name:"Telencephalon",url:"http://neurolex.org/wiki/Category:Telencephalon",parts:[
					{name:"Neocortex",url:"http://neurolex.org/wiki/Category:Neocortex"},
					{name:"Rhinencephalon"},
					{name:"Amygdala",url:"http://neurolex.org/wiki/Category:Amygdala"},
					{name:"Hippocampus",url:"http://neurolex.org/wiki/Category:Hippocampus"},
					{name:"Basal Ganglia",url:"http://neurolex.org/wiki/Category:Basal_ganglia"}
				 ]},
				 {name:"Diencephalon",url:"http://neurolex.org/wiki/Category:Diencephalon",parts:[
					{name:"Thalamus",url:"http://neurolex.org/wiki/Category:Thalamus"},
					{name:"Hypothalamus"},
					{name:"Epithalamus"},
					{name:"Subthalamus"},
					{name:"Pituitary Gland"},
					{name:"Pineal Gland"}
				 ]},
				 {name:"Mesencephalon",parts:[
					{name:"Tectum"},
					{name:"Pretectum"},
					{name:"Cerebral Peduncle"}
				 ]},
				 {name:"Rhombencephalon",parts:[
					{name:"Pons"},
					{name:"Cerebellum"},
					{name:"Medulla Oblongata"}
				]}];
</script>

<script>
var	debug=false;
//var dbroot="http://siphonophore.org/interact/php/interact.php";
var dbroot="http://localhost/interact/php/interact.php";

var Regions=[]; 	// main list of regions. Contains a paper.js path, a unique ID and a name;
var region=null;	// currently selected region (one element of Regions[])
var handle;			// currently selected control point or handle (if any)
var newRegionFlag;	
var selectedTool="zoom";
var viewer;			// open seadragon viewer
var navEnabled=true;// flag indicating whether the navigator is enabled (if it's not, the annotation tools are)
var magicV=1000;	// resolution of the annotation canvas
var myOrigin={};	// Origin identification for DB storage
var	params;			// URL parameters
var	myIP;			// user's IP

/*
	Region handling functions
*/
function newRegion(arg) {
	if(debug) console.log("> newRegion");
	
	var reg={};
	
	reg.uid=regionUniqueID();
	if(arg.name)
		reg.name=arg.name;
	else {
		reg.name="Untitled "+reg.uid;
	}
	var color=regionHashColor(reg.name);
	
	if(arg.path) {
		reg.path = arg.path;
		reg.path.strokeWidth=1;
		reg.path.strokeColor='black';
		reg.path.strokeScaling=false;
		reg.path.fillColor='rgba('+color.red+','+color.green+','+color.blue+',0.5)';
		reg.path.selected=false;
	}
	
	// append region tag to regionList
	var el=$(regionTag(reg.name,reg.uid));
	$("#regionList").append(el);
	
	// handle single click on computers
	el.click(singlePressOnRegion);
	
	// handle double click on computers
	el.dblclick(doublePressOnRegion);
	
	// handle single and double tap on touch devices
	/*
		RT: it seems that a click event is also fired on touch devices,
		making this one redundant
	*/
	el.on("touchstart",handleRegionTap);

	// push the new region to the Regions array
	Regions.push(reg);
	
	if(debug) console.log("< newRegion");
	return reg;
}
function removeRegion(reg) {
	if(debug) console.log("> removeRegion");
	
	// remove from Regions array
	Regions.splice(Regions.indexOf(reg),1);
	// remove from paths
	reg.path.remove();
	// remove from regionList
	var	tag=$("#regionList > .region-tag#"+reg.uid);
	$(tag).remove();
}
function selectRegion(reg) {
	if(debug) console.log("> selectRegion");
	
	var	i;

	// Select path
	for(i=0;i<Regions.length;i++) {
		if(Regions[i]==reg) {
			reg.path.selected=true;
			reg.path.fullySelected=true;
			region=reg;
		}
		else {
			Regions[i].selected=false;
			Regions[i].path.fullySelected=false;
		}
	}
	paper.view.draw();
	
	// Select region name in list
	$("#regionList > .region-tag").each(function(i){
		$(this).addClass("deselected");
		$(this).removeClass("selected");
	});

	var	tag=$("#regionList > .region-tag#"+reg.uid);
	$(tag).removeClass("deselected");
	$(tag).addClass("selected");
	
	if(debug) console.log("< selectRegion");
}
function findRegionByUID(uid) {
	if(debug) console.log("> findRegionByUID");
	
	var	i;
	for(i=0;i<Regions.length;i++) {
		if(Regions[i].uid==uid) {
			return Regions[i];
		}
	}
	console.log("Region with unique ID "+uid+" not found");
	return null;
}
var counter=1;
function regionUniqueID() {
	if(debug) console.log("> regionUniqueID");
	
	var i;
	var	found=false;
	while(found==false) {
		found=true;
		for(i=0;i<Regions.length;i++) {
			if(Regions[i].uid==counter) {
				counter++;
				found=false;
				break;
			}
		}
	}
	return counter;
}

function regionHashColor(name) {
	if(debug) console.log("> regionHashColor");
	
	var color={};
	var hash=name.split("").reduce(function(a,b){
		a=((a<<5)-a)+b.charCodeAt(0);return a&a
	},0);

	// add some randomness
    hash=Math.sin(hash++)*10000;
    hash=0xffffff*(hash-Math.floor(hash));
	
	color.red=hash&0xff;
	color.green=(hash&0xff00)>>8;
	color.blue=(hash&0xff0000)>>16;
	return color;
}
function regionTag(name,uid) {
	if(debug) console.log("> regionTag");
	
	var color=regionHashColor(name);
	var	str;
	if(uid)
		str=[	"<div class='region-tag' id='"+uid+"' style='padding:2px'>",
				"<div class='region-color'",
				"style='background-color:rgba(",
				color.red,",",color.green,",",color.blue,",0.67",
				")'></div>",
				"<span class='region-name'>"+name+"</span>",
				"</div>",
				].join(" ");
	else
		str=[	"<div class='region-tag' style='padding:2px'>",
				"<div class='region-color'",
				"style='background-color:rgba(",
				color.red,",",color.green,",",color.blue,",0.67",
				")'></div>",
				"<span class='region-name'>"+name+"</span>",
				"</div>",
				].join(" ");
	return str;
}
function appendRegionTagsFromOntology(o) {
	if(debug) console.log("> appendRegionTagsFromOntology");
	
	for(var i=0;i<o.length;i++) {
		if(o[i].parts) {
			$("#regionPicker").append("<div>"+o[i].name+"</div>");
			appendRegionTagsFromOntology(o[i].parts);
		}
		else {
			var tag=regionTag(o[i].name);
			var	el=$(tag).addClass("ontology");
			$("#regionPicker").append(el);

			// handle single click on computers
			el.click(singlePressOnRegion);
	
			// handle double click on computers
			el.dblclick(doublePressOnRegion);

			el.on("touchstart",handleRegionTap);
		}
	}
}
function regionPicker(parent) {
	if(debug) console.log("> regionPicker");
	
	$("div#regionPicker").appendTo("body");
	$("div#regionPicker").show();
}

function changeRegionName(reg,name) {
	if(debug) console.log("> changeRegionName");
	
	var i;
	var color=regionHashColor(name);

	// Update path
	reg.name=name;
	reg.path.fillColor='rgba('+color.red+','+color.green+','+color.blue+',0.5)';
	paper.view.draw();
	
	// Update region tag
	$(".region-tag#"+reg.uid+">.region-name").text(name);
	$(".region-tag#"+reg.uid+">.region-color").css('background-color','rgba('+color.red+','+color.green+','+color.blue+',0.67)');
}

/*
	Interaction: mouse and tap
*/
function clickHandler(event){
	if(debug) console.log("> clickHandler");
	event.stopHandlers=!navEnabled;
}
function pressHandler(event){
	if(debug) console.log("> pressHandler");
	if(!navEnabled) {
		event.stopHandlers = true;
		mouseDown(event.originalEvent.layerX,event.originalEvent.layerY);
	}
}
function dragHandler(event){
	if(debug) console.log("> dragHandler");
	var zoom =viewer.viewport.viewportToImageZoom(viewer.viewport.getZoom(true));
	var z=magicV/viewer.source.width/zoom
	if(!navEnabled) {
		event.stopHandlers = true;
		mouseDrag(event.originalEvent.layerX,event.originalEvent.layerY);
	}
}
function dragEndHandler(event){
	if(debug) console.log("> dragEndHandler");
	if(!navEnabled) {
		event.stopHandlers = true;
		mouseUp();
	}
}
function singlePressOnRegion(event) {
	if(debug) console.log("> singlePressOnRegion");
	
	event.stopPropagation();
	event.preventDefault();

	var	el=$(this);
	var	uid;
	var	reg;
	
	if(el.hasClass("ontology")) {
		// Click on regionPicker (ontology selection list)
		var newName=el.find(".region-name").text();
		uid=$(".region-tag.selected").attr('id');
		reg=findRegionByUID(uid);
		changeRegionName(reg,newName);
		$("div#regionPicker").appendTo($("body")).hide();
	}
	else {
		// Click on regionList (list or annotated regions)
		uid=$(this).attr('id');
		reg=findRegionByUID(uid);
		if(reg)
			selectRegion(reg);
		else
			console.log("region undefined");
	}
}
function doublePressOnRegion(event) {
	if(debug) console.log("> doublePressOnRegion");
	
	event.stopPropagation();
	event.preventDefault();

	regionPicker(this);
}
var tap=false
function handleRegionTap(event) {
/*
	Handles single and double tap in touch devices
*/
	if(debug) console.log("> handleRegionTap");
	var	caller=this;
	
	if(!tap){ //if tap is not set, set up single tap
		tap=setTimeout(function(){
			tap=null
		},300);
		
		// call singlePressOnRegion(event) using 'this' as context
		singlePressOnRegion.call(this,event);
	} else {
		clearTimeout(tap);
		tap=null;
		
		// call doublePressOnRegion(event) using 'this' as context
		doublePressOnRegion.call(this,event);
	}
	if(debug) console.log("< handleRegionTap");
}
function mouseDown(x,y) {
	if(debug) console.log("> mouseDown");
	
	var prevRegion=null;
	var point=paper.view.viewToProject(new paper.Point(x,y));
	
	handle=null;

	switch(selectedTool) {
		case "select":
		case "addpoint":
		case "delpoint":
		case "addregion":
		case "delregion":
		case "splitregion":
			var hitResult=paper.project.hitTest(point, {
					tolerance:2,
					stroke: true,
					segments:true,
					fill: true,
					handles:true
				});
			newRegionFlag=false;
			if (hitResult) {
				var i;
				for(i=0;i<Regions.length;i++) {
					if(Regions[i].path==hitResult.item) {
						re=Regions[i];
						break;
					}
				}

				// select path
				if(region && region!=re) {
					region.path.selected=false;
					prevRegion=region;
				}
				selectRegion(re);
				//re.path.fullySelected=true;
				//region=re;
		
				if (hitResult.type == 'handle-in') {
					handle = hitResult.segment.handleIn;
					handle.point=point;
				} else
				if (hitResult.type == 'handle-out') {
					handle = hitResult.segment.handleOut;
					handle.point=point;
				} else
				if (hitResult.type=='segment') {
					if(selectedTool=="select") {
						handle=hitResult.segment.point;
						handle.point=point;
					}
					if(selectedTool=="delpoint")
						hitResult.segment.remove();
				} else
				if (hitResult.type=='stroke' && selectedTool=="addpoint") {
					region.path
					.curves[hitResult.location.index]
					.divide(hitResult.location);
					region.path.fullySelected=true;
					paper.view.draw();
				} else
				if (selectedTool=="addregion") {
					if(prevRegion) {
						var newPath=region.path.unite(prevRegion.path);
						removeRegion(prevRegion);
						region.path.remove();
						region.path=newPath;
					}
				} else
				if (selectedTool=="delregion") {
					if(prevRegion) {
						var newPath=prevRegion.path.subtract(region.path);
						removeRegion(prevRegion);
						prevRegion.path.remove();
						newRegion({path:newPath});
					}
				} else
				if (selectedTool=="splitregion") {
					if(prevRegion) {
						var newPath=region.path.divide(prevRegion.path);
						removeRegion(prevRegion);
						region.path.remove();
						region.path=newPath;
						for(i=0;i<newPath._children.length;i++)
						{
							if(i==0)
								region.path=newPath._children[i];
							else {
								newRegion({path:newPath._children[i]});
							}
						}
					}
				}
				break;
			}
			if(hitResult==null && region) {
				// deselect paths
				region.path.selected=false;
				region=null;
			}
			break;
		case "draw":
			// Start a new region
			// if there was an older region selected, unselect it
			if(region)
				region.path.selected = false;
			// start a new region
			region=newRegion({path:new paper.Path({segments:[point]})});
			// signal that a new region has been created for drawing
			newRegionFlag=true;
			break;
	}
	paper.view.draw();
}
function mouseDrag(x,y) {
	if(debug) console.log("> mouseDrag");
	var point=paper.view.viewToProject(new paper.Point(x,y));
	if (handle) {
		handle.x+=point.x-handle.point.x;
		handle.y+=point.y-handle.point.y;
		handle.point=point;
	} else
	if(selectedTool=="draw") {
		region.path.add(point);
	}
	paper.view.draw();
}
function mouseUp() {
	if(debug) console.log("> mouseUp");
	if(newRegionFlag==true){
		region.path.simplify(10);
		region.path.closed=true;
		region.path.fullySelected = true;
	}
	paper.view.draw();
}

/*
	Tool selection
*/
function toolSelection(event) {
	if(debug) console.log("> toolSelection");
	
	var prevTool=selectedTool;
	selectedTool=$(this).attr("id");
	selectTool();
	
	switch(selectedTool) {
		case "select":
		case "addregion":
		case "delregion":
		case "addpoint":
		case "delpoint":
		case "draw":
			navEnabled=false;
			break;
		case "zoom":
			navEnabled=true;
			handle=null;
			break;
		case "delete":
			for(i in Regions) {
				if(Regions[i].path.selected) {
					removeRegion(Regions[i]);
					paper.view.draw();
					break;
				}
			}
			// go back to previous tool
			setTimeout(function() {
				selectedTool=prevTool;
				selectTool()
			},500);
			break;
		case "save":
			interactSave();
			setTimeout(function() {
				selectedTool=prevTool;
				selectTool()
			},500);
			break;
	}
}
function selectTool() {
	if(debug) console.log("> selectTool");
	
	$("button").removeClass("selected");
	$("button#"+selectedTool).addClass("selected");
	//$("svg").removeClass("selected");
	//$("svg#"+selectedTool).addClass("selected");
}

/*
	Annotation storage
*/
/* Interact push/pull */
function interactSave() {
/*
	Save SVG overlay to Interact DB
*/
	if(debug) console.log("> save");
	
	var i;
	var	key;
	var value;
	var el;
	var origin;

	// key
	key="regionPaths";
	
	// configure value to be saved
	value={};
	value.Regions=[];
	for(i=0;i<Regions.length;i++)
	{
		el={};
		el.path=JSON.parse(Regions[i].path.exportJSON());
		el.name=Regions[i].name;
		value.Regions.push(el);
	}
	
	$.ajax({
		url:dbroot,
		type:"POST",
		data:{
			"action":"save",
			"origin":JSON.stringify(myOrigin),
			"key":key,
			"value":JSON.stringify(value)
		},
		success: function(data) {
			console.log("Successfully saved regions:",Regions.length);
		},
		error: function(jqXHR, textStatus, errorThrown) {
			console.log("ERROR: " + textStatus + " " + errorThrown);
		}
	});
}
function interactLoad() {
/*
	Load SVG overlay from Interact DB
*/
	if(debug) console.log("> load");
	
	var	key="regionPaths";
	
	$.get(dbroot,{
		"action":"load_last",
		"origin":JSON.stringify(myOrigin),
		"key":key
	}).success(function(data) {
		var	i,obj,reg;
		$("#regionList").html("");
		obj=JSON.parse(data);
		if(obj) {
			obj=JSON.parse(obj.myValue);
			for(i=0;i<obj.Regions.length;i++) {
				var reg={};
				var	json;
				reg.name=obj.Regions[i].name;
				json=obj.Regions[i].path;
				reg.path=new paper.Path();
				reg.path.importJSON(json);
				newRegion({name:reg.name,path:reg.path});
			}
			paper.view.draw();
		}
	}).error(function(jqXHR, textStatus, errorThrown) {
        console.log("ERROR: " + textStatus + " " + errorThrown);
    });
}
function interactIP() {
/*
	Get my IP
*/
	$("#regionList").html("<br />Connecting to database...");
	return $.get(dbroot,{
		"action":"remote_address"
	}).success(function(data) {
		myIP=data;
	}).error(function(jqXHR, textStatus, errorThrown) {
		$("#regionList").html("<br />Error: Unable to connect to database.");
        console.log("Error: " + textStatus + " " + errorThrown);
    });
}

function save() {
	if(debug) console.log("> save");
	
	var i;
	var obj;
	var el;

	obj={};
	obj.Regions=[];
	for(i=0;i<Regions.length;i++)
	{
		el={};
		el.path=Regions[i].path.exportJSON();
		el.name=Regions[i].name;
		obj.Regions.push(el);
	}
	localStorage.Microdraw=JSON.stringify(obj);
	console.log("saved regions:",Regions.length);
}
function load() {
	if(debug) console.log("> load");
	
	var	i,obj,reg;
	if(localStorage.Microdraw) {
		console.log("Loading data from localStorage");
		obj=JSON.parse(localStorage.Microdraw);
		for(i=0;i<obj.Regions.length;i++) {
			var reg={};
			var	json;
			reg.name=obj.Regions[i].name;
			json=obj.Regions[i].path;
			reg.path=new paper.Path();
			reg.path.importJSON(json);
			newRegion({name:reg.name,path:reg.path});
		}
		paper.view.draw();
	}
}

/*
	Initialisation
*/
var initialZoom;
function initAnnotationOverlay() {
	if(debug) console.log("> initAnnotationOverlay");
	
	// set up vectorial annotation overlay
	initialZoom=viewer.viewport.viewportToImageZoom(viewer.viewport.getZoom(true));
	var zoom=initialZoom;
	//var aspect=viewer.source.height/viewer.source.width;
	var width=$("body").width();//magicV;//
	var height=$("body").height();//magicV*aspect;//
	$("body").append("<canvas class='overlay'></canvas>");
	$("canvas.overlay").attr("width",width);
	$("canvas.overlay").attr("height",height);
	console.log("setup canvas");
	var	canvas=$("canvas.overlay")[0];
	canvas.className="overlay";
	paper.setup(canvas);
	paper.settings.handleSize=10;
	
	viewer.addHandler('animation', function(event){
		transform()
	});
	transform();
}

function transform() {
	var z=viewer.viewport.viewportToImageZoom(viewer.viewport.getZoom(true));
	var sw=viewer.source.width;
	var bounds=viewer.viewport.getBounds(true);
    var	x=magicV*bounds.x;
    var	y=magicV*bounds.y;
    var	w=magicV*bounds.width;
    var	h=magicV*bounds.height;
    paper.view.setCenter(x+w/2,y+h/2);
    paper.view.zoom=(sw*z)/magicV;
}
function deparam() {
	var search = location.search.substring(1);
	return search?JSON.parse('{"' + search.replace(/&/g, '","').replace(/=/g,'":"') + '"}',
					 function(key, value) { return key===""?value:decodeURIComponent(value) }):{}	
}
function loginChanged() {
	console.log("Got login update");
	myOrigin.user=MyLoginWidget.username;
}
function makeSVGInline() {
	var def=$.Deferred();
	$('img.svg').each(function(){
		var $img = $(this);
		var imgID = $img.attr('id');
		var imgClass = $img.attr('class');
		var imgURL = $img.attr('src');

		$.get(imgURL, function(data) {
			// Get the SVG tag, ignore the rest
			var $svg = $(data).find('svg');

			// Add replaced image's ID to the new SVG
			if(typeof imgID !== 'undefined') {
				$svg = $svg.attr('id', imgID);
			}
			// Add replaced image's classes to the new SVG
			if(typeof imgClass !== 'undefined') {
				$svg = $svg.attr('class', imgClass+' replaced-svg');
			}

			// Remove any invalid XML tags as per http://validator.w3.org
			$svg = $svg.removeAttr('xmlns:a');

			// Replace image with new SVG
			$img.replaceWith($svg);
			
			def.resolve();

		}, 'xml');

	});
	
	return def.promise();
}
function initMicrodraw() {
	if(debug) console.log("> initMicrodraw");
	
	// Get URL parameters, in particular, image source
	params=deparam();
	
	// Subscribe to login changes
	MyLoginWidget.subscribe(loginChanged);
	
	$("button").click(toolSelection);

	viewer = OpenSeadragon({
		id: "openseadragon1",
		prefixUrl: "lib/openseadragon/images/",
		tileSources: params.source,
		showNavigator: true,
		navigatorId:"myNavigator",
		zoomInButton:"zoom-in",
		zoomOutButton:"zoom-out",
		homeButton:"home"
	});
	viewer.scalebar({
		type: OpenSeadragon.ScalebarType.MICROSCOPE,
		minWidth:'150px',
		pixelsPerMeter:1000000,
		color:'black',
		fontColor:'black',
		backgroundColor:"rgba(255,255,255,0.5)",
		barThickness:4,
		location: OpenSeadragon.ScalebarLocation.TOP_RIGHT,
		xOffset:5,
		yOffset:5
	});
	viewer.addHandler('open',initAnnotationOverlay);

	viewer.addViewerInputHook({hooks: [
		{tracker: 'viewer', handler: 'clickHandler', hookHandler: clickHandler},
		{tracker: 'viewer', handler: 'pressHandler', hookHandler: pressHandler},
		{tracker: 'viewer', handler: 'dragHandler', hookHandler: dragHandler},
		{tracker: 'viewer', handler: 'dragEndHandler', hookHandler: dragEndHandler}
	]});
	
	$("#regionList").height($(window).height()-$("#regionList").offset().top);
	$(window).resize(function() {
		$("#regionList").height($(window).height()-$("#regionList").offset().top);
	});

	appendRegionTagsFromOntology(Ontology);
	
	makeSVGInline().then(selectTool());
}

$.when(
	interactIP(),
	MyLoginWidget.init()
).then(function(){
	myOrigin.appName="microdraw";
	myOrigin.source=params.source;
	myOrigin.IP=myIP;
	myOrigin.user=MyLoginWidget.username;
	myOrigin.hash=navigator.userAgent.split("").reduce(function(a,b){
		a=((a<<5)-a)+b.charCodeAt(0);return a&a
	},0).toString(16);

	// Log microdraw
	//interactSave(JSON.stringify(myOrigin),"entered",null);

	// load SVG overlay from localStorage
	interactLoad();
	//load();
});
initMicrodraw();

</script>
</body>
</html>


